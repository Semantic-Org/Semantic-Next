---
import { getCollection } from 'astro:content';
import { each, findIndex, tokenize } from '@semantic-ui/utils';
import { getExampleFiles, addPlaygroundInjections, getSandboxURL, getPanelIndexes } from '@helpers/playground.js';
import { lessonPages, getSidebarMenu } from '@helpers/navigation.js';
import NavMenu from '@components/NavMenu/NavMenu.js';

import Playground from '@layouts/Playground.astro';
import LearnExample from '@components/LearnExample/LearnExample.js';
import Sidebar from '@components/Sidebar.astro';

const { entry } = Astro.props;

/* Make paths */
export async function getStaticPaths() {
  const entries = await getCollection('lessons');
  const paths = [];
  each(entries, (entry) => {
    paths.push({
      params: { slug: `${entry.slug}` },
      props: { entry },
    });
  });
  return paths;
}
const activeURL = Astro.url.pathname;

const lesson = entry.data;
const lessonIndex = findIndex(lessonPages, lesson => lesson.url == activeURL);
const previousLesson = (lessonIndex > -1) ? lessonPages[lessonIndex - 1] : {};
const nextLesson = (lessonIndex > -1) ? lessonPages[lessonIndex + 1] : {};

/* Get associated example */
const sandboxURL = getSandboxURL();
const example = 'counter';
const allExampleFiles = await import.meta.glob(`../../examples/**`, {
  query: '?raw',
});
let files = await getExampleFiles(example, allExampleFiles, '../../examples/');
files = addPlaygroundInjections(files, example.exampleType);

const panelIndexes = getPanelIndexes(files, example.exampleType);

const { Content } = await entry.render();

const searchMeta = {
  ...entry.data,
  pageType: 'Learn',
}

const menu = await getSidebarMenu({url: activeURL});

const playgroundConfig = {
  files,
  example,
  sandboxURL,
  panelIndexes
};

---

<Playground searchMeta={searchMeta} showSidebar=true>
  <page data-pagefind-body class="text-content">
    <LearnExample client:only
      lesson={lesson}
      previousLesson={previousLesson}
      nextLesson={nextLesson}
      menu={menu}
      activeURL={activeURL}
      playgroundConfig={playgroundConfig}
    >
      <pageContent>
        <Content />
      </pageConent>
    </LearnExample>
  </page>
</Playground>
